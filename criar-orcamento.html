<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Orçamento • OrçaFácil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Previne zoom no iOS */
        input,
        select,
        textarea {
            font-size: 16px !important;
        }

        @media (min-width: 768px) {

            input,
            select,
            textarea {
                font-size: 0.875rem !important;
            }
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body class="bg-[#F0F4F8] text-slate-800 min-h-screen flex flex-col">

    <header class="w-full px-8 py-6 flex justify-between items-center bg-transparent">
        <a href="dashboard.html"
            class="flex items-center gap-2 text-slate-800 hover:opacity-80 transition-opacity group">
            <div
                class="bg-blue-600 text-white p-1.5 rounded-lg group-hover:scale-110 transition-transform shadow-lg shadow-blue-500/20">
                <i class="ph-bold ph-hexagon text-xl"></i>
            </div>
            <span class="font-bold text-xl tracking-tight text-blue-900">OrçaFácil</span>
        </a>
    </header>

    <main class="flex-1 flex flex-col items-center justify-center p-4 pb-32">
        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 mb-8 flex items-center gap-2">
            <i class="ph-duotone ph-file-plus text-blue-600"></i> Criar Novo Orçamento
        </h1>

        <div class="bg-white w-full max-w-4xl p-8 rounded-xl shadow-xl shadow-slate-200/60 border border-slate-100">
            <form id="form-criar-completo" class="space-y-8">
                <!-- Seção Cliente -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
                    <div
                        class="p-5 md:p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 border-b border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0 text-blue-600">
                                <i class="ph-duotone ph-user text-2xl"></i>
                            </div>
                            <h3 class="text-sm font-bold text-slate-800 leading-tight uppercase tracking-wide">
                                Informações do<br>Cliente
                            </h3>
                        </div>
                    </div>

                    <div class="p-5 md:p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Linha 1: Select Full Width -->
                        <div class="md:col-span-3">
                            <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider">
                                <i class="ph-bold ph-lightning text-amber-500"></i> Preencher Rápido (Cliente Existente)
                            </label>
                            <div class="relative group">
                                <span
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-amber-500 transition-colors z-10">
                                    <i class="ph-bold ph-magnifying-glass text-lg"></i>
                                </span>
                                <select id="select-cliente" onchange="preencherDadosCliente()"
                                    class="w-full pl-12 pr-10 py-3 bg-amber-50/50 border border-amber-200/60 rounded-xl focus:outline-none focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 appearance-none transition-all cursor-pointer text-base md:text-sm font-medium text-slate-700 hover:border-amber-300">
                                    <option value="">Selecione para preencher...</option>
                                </select>
                                <i
                                    class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Linha 2: Campos do Cliente + Data Validade -->
                        <div id="form-novo-cliente"
                            class="md:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-100">
                            <div class="md:col-span-2 flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Dados do
                                    Cliente & Orçamento</span>
                                <div class="flex gap-2">
                                    <button type="button" onclick="novoCliente()"
                                        class="text-[10px] font-bold text-green-600 hover:text-green-800 transition-colors flex items-center gap-1">
                                        <i class="ph-bold ph-plus-circle"></i> Novo Cliente
                                    </button>
                                    <button type="button" onclick="limparCamposCliente()"
                                        class="text-[10px] font-bold text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-1">
                                        <i class="ph-bold ph-eraser"></i> Limpar
                                    </button>
                                </div>
                            </div>

                            <!-- Nome e Data Validade lado a lado em desktop -->
                            <div class="col-span-1 md:col-span-1">
                                <input type="text" id="novo-cli-nome" placeholder="Nome Completo *"
                                    class="w-full px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-bold text-slate-700">
                            </div>

                            <div class="col-span-1 md:col-span-1">
                                <div class="relative group">
                                    <span
                                        class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-blue-500 transition-colors z-10">
                                        <i class="ph-bold ph-calendar-blank text-lg"></i>
                                    </span>
                                    <input type="date" id="input-validade"
                                        class="w-full pl-12 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all text-sm font-medium text-slate-600 cursor-pointer hover:border-blue-300">
                                </div>
                            </div>

                            <!-- Resto dos campos -->
                            <input type="tel" id="novo-cli-phone" placeholder="Telemóvel"
                                class="px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">

                            <input type="email" id="novo-cli-email" placeholder="E-mail"
                                class="px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">

                            <input type="text" id="novo-cli-cpf" placeholder="NIF OU NIPC (Opcional)"
                                class="px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">

                            <input type="text" id="novo-cli-empresa" placeholder="Empresa / Loja"
                                class="px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">

                            <input type="text" id="novo-cli-endereco" placeholder="Morada Completa"
                                class="col-span-1 md:col-span-2 px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">
                        </div>
                    </div>
                </div>

                <!-- Seção Itens -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-5 md:p-6 border-b border-slate-100 bg-slate-50/50">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-lg bg-white border border-slate-100 flex items-center justify-center text-blue-600 flex-shrink-0 shadow-sm">
                                    <i class="ph-duotone ph-cube text-2xl"></i>
                                </div>
                                <h3 class="text-sm font-bold text-slate-800 leading-tight">
                                    PRODUTOS &<br>SERVIÇOS
                                </h3>
                            </div>
                        </div>

                        <!-- Inline Add Form -->
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-3">
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-slate-400 mb-1 uppercase flex items-center gap-1">
                                    <i class="ph-bold ph-lightning text-amber-500"></i> Catálogo (Preencher Rápido)
                                </label>
                                <div class="relative">
                                    <select id="select-item-inline" onchange="preencherItemInline()"
                                        class="w-full pl-10 pr-8 py-3 bg-amber-50/50 border border-amber-200/60 rounded-lg focus:outline-none focus:border-amber-500 text-base md:text-sm font-medium text-slate-700 appearance-none cursor-pointer hover:border-amber-300 transition-colors">
                                        <option value="">Selecione um item do catálogo...</option>
                                    </select>
                                    <i
                                        class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i>
                                    <i
                                        class="ph-bold ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="grid grid-cols-12 gap-3 items-end">
                                <!-- Linha 1: Tipo e Nome -->
                                <div class="col-span-12 md:col-span-3">
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Tipo</label>
                                    <div class="relative">
                                        <select id="inline-tipo" onchange="toggleInlineTipo()"
                                            class="w-full px-3 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-blue-500 text-base md:text-sm font-bold text-slate-700 appearance-none cursor-pointer">
                                            <option value="Serviço">Serviço</option>
                                            <option value="Produto">Produto</option>
                                        </select>
                                        <i
                                            class="ph-bold ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>
                                <div class="col-span-12 md:col-span-9">
                                    <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Nome
                                        do Item</label>
                                    <input type="text" id="inline-nome" placeholder="Ex: Instalação Elétrica"
                                        class="w-full px-3 py-2.5 bg-white border border-slate-200 rounded-lg focus:outline-none focus:border-blue-500 font-bold text-slate-700 text-sm">
                                </div>

                                <!-- Linha 2: Descrição e Valores -->
                                <div class="col-span-12 md:col-span-12">
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Descrição</label>
                                    <textarea id="inline-descricao" rows="2"
                                        placeholder="Descreva os detalhes do serviço ou produto..."
                                        class="w-full px-3 py-2.5 bg-white border border-slate-200 rounded-lg focus:outline-none focus:border-blue-500 text-slate-700 text-sm resize-none"></textarea>
                                </div>

                                <div class="col-span-6 md:col-span-3">
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 mb-1 uppercase text-right">Preço
                                        Unit. (€)</label>
                                    <input type="text" inputmode="decimal" id="inline-preco" placeholder="0,00"
                                        class="w-full px-3 py-2.5 text-right bg-white border border-slate-200 rounded-lg focus:outline-none focus:border-blue-500 font-bold text-slate-700 text-sm">
                                </div>

                                <!-- Falta: Mão de Obra (Serviço) ou Frete (Produto) -->
                                <div id="inline-box-mo" class="col-span-6 md:col-span-3">
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 mb-1 uppercase text-right">Mão
                                        de Obra (€)</label>
                                    <input type="text" inputmode="decimal" id="inline-mao-obra" placeholder="0,00"
                                        class="w-full px-3 py-2.5 text-right bg-white border border-slate-200 rounded-lg focus:outline-none focus:border-blue-500 font-medium text-slate-600 text-sm">
                                </div>
                                <div id="inline-box-frete" class="col-span-6 md:col-span-3 hidden">
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 mb-1 uppercase text-right">Frete
                                        (€)</label>
                                    <input type="text" inputmode="decimal" id="inline-frete" placeholder="0,00"
                                        class="w-full px-3 py-2.5 text-right bg-white border border-slate-200 rounded-lg focus:outline-none focus:border-blue-500 font-medium text-slate-600 text-sm">
                                </div>

                                <div class="col-span-12 md:col-span-4">
                                    <button type="button" onclick="adicionarItemInline()"
                                        class="w-full bg-slate-800 hover:bg-slate-900 text-white text-sm font-bold py-2.5 rounded-lg shadow-lg shadow-slate-500/20 active:scale-95 transition-all flex items-center justify-center gap-2">
                                        <i class="ph-bold ph-plus"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm min-w-[300px]">
                            <thead
                                class="bg-slate-50/50 text-slate-500 font-bold border-b border-slate-100 text-[10px] uppercase tracking-wider">
                                <tr>
                                    <th class="p-3 pl-5">Nome do Item / Descrição</th>
                                    <th class="p-3 w-32 text-right">Valor Total</th>
                                    <th class="p-3 w-10 text-center"></th>
                                </tr>
                            </thead>
                            <tbody id="lista-itens-orcamento" class="divide-y divide-slate-50 bg-white"></tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="empty-itens" class="p-10 text-center text-slate-300 flex flex-col items-center">
                        <i class="ph-duotone ph-package text-4xl mb-3 opacity-40"></i>
                        <span class="text-sm font-medium text-slate-500">A sua lista está vazia</span>
                    </div>

                    <!-- Resumo de Totais -->
                    <div class="p-5 md:p-6 bg-slate-50/50 space-y-2 border-t border-slate-100">
                        <div class="flex justify-between items-center text-xs font-medium text-slate-500">
                            <span class="pl-1">Subtotal Produtos</span>
                            <span class="pr-1" id="subtotal-produtos">--</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-medium text-slate-500">
                            <span class="pl-1">Mão de Obra</span>
                            <span class="pr-1" id="subtotal-mao-obra">--</span>
                        </div>
                        <div
                            class="flex justify-between items-center text-xs font-medium text-slate-500 pb-3 border-b border-slate-200">
                            <span class="pl-1">Frete / Entregas</span>
                            <span class="pr-1" id="subtotal-frete">--</span>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                            <div class="flex flex-col pl-1">
                                <span class="text-sm font-black uppercase text-black">Total</span>
                            </div>
                            <span id="orc-valor" class="text-2xl font-black text-blue-600">€ 0,00</span>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="flex flex-col sm:flex-row gap-4 mt-8">
                    <button type="button" onclick="salvarOrcamentoCompleto()"
                        class="w-full sm:flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 px-6 rounded-xl shadow-lg shadow-blue-500/25 active:scale-[0.98] transition-all flex justify-center items-center gap-2.5">
                        <i class="ph-bold ph-floppy-disk text-xl"></i> <span>Guardar e Gerar</span>
                    </button>
                    <button type="button" onclick="window.history.back()"
                        class="w-full sm:w-auto px-8 py-3.5 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-50 hover:border-slate-300 transition-all active:scale-95 shadow-sm">
                        Cancelar
                    </button>
                </div>

                <!-- Campos ocultos para processamento -->
                <input type="hidden" id="input-valor" value="0">
                <input type="hidden" id="input-descricao" value="">
                <input type="hidden" id="input-mao-obra-total" value="0">
                <input type="hidden" id="input-itens-json" value="[]">
                <input type="hidden" id="subtotal-display" value="€ 0,00">
            </form>
        </div>
    </main>

    <!-- Navegação Inferior Premium -->
    <nav
        class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-md border border-slate-200 rounded-full shadow-2xl p-2 flex items-center gap-1 z-50 whitespace-nowrap scale-90 md:scale-100 transition-all origin-bottom print:hidden">
        <a href="dashboard.html"
            class="flex items-center gap-2 px-4 py-2.5 text-slate-500 hover:bg-slate-100 rounded-full font-medium text-sm transition-all hover:text-blue-600">
            <i class="ph-bold ph-house text-lg"></i> <span class="hidden md:inline">Dashboard</span>
        </a>
        <a href="orcamentos.html"
            class="flex items-center gap-2 px-4 py-2.5 text-slate-500 hover:bg-slate-100 rounded-full font-medium text-sm transition-all hover:text-blue-600">
            <i class="ph-bold ph-file-text text-lg"></i> <span class="hidden md:inline">Orçamentos</span>
        </a>
        <a href="criar-orcamento.html"
            class="flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-full font-bold text-sm shadow-lg shadow-blue-500/30 transition-all">
            <i class="ph-bold ph-plus text-lg"></i> <span class="hidden md:inline">Novo</span>
        </a>
        <a href="clientes.html"
            class="flex items-center gap-2 px-4 py-2.5 text-slate-500 hover:bg-slate-100 rounded-full font-medium text-sm transition-all hover:text-blue-600">
            <i class="ph-bold ph-users text-lg"></i> <span class="hidden md:inline">Clientes</span>
        </a>
        <a href="catalogo.html"
            class="flex items-center gap-2 px-4 py-2.5 text-slate-500 hover:bg-slate-100 rounded-full font-medium text-sm transition-all hover:text-blue-600">
            <i class="ph-bold ph-cube text-lg"></i> <span class="hidden md:inline">Itens</span>
        </a>
        <a href="ajustes.html"
            class="flex items-center gap-2 px-4 py-2.5 text-slate-500 hover:bg-slate-100 rounded-full font-medium text-sm transition-all hover:text-blue-600">
            <i class="ph-bold ph-gear text-lg"></i> <span class="hidden md:inline">Config</span>
        </a>
    </nav>

    <!-- Modal Cliente -->
    <div id="modal-cliente" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form id="form-cliente" class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="w-full">
                            <h3 id="modal-cliente-titulo" class="text-lg leading-6 font-medium text-gray-900">Novo
                                Cliente</h3>
                            <div class="mt-6 grid grid-cols-1 gap-4">
                                <input type="hidden" id="cli-id">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nome *</label>
                                    <input type="text" id="cli-nome" required
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="cli-email"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Telefone</label>
                                    <input type="tel" id="cli-phone"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Empresa</label>
                                    <input type="text" id="cli-empresa"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">NIF</label>
                                    <input type="text" id="cli-cpf"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Endereço</label>
                                    <input type="text" id="cli-endereco"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-6 sm:flex sm:flex-row-reverse">
                        <button type="button" onclick="salvarCliente()"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                            <i class="ph-bold ph-check"></i> Guardar Cliente
                        </button>
                        <button type="button" onclick="toggleModal('modal-cliente', 'close')"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js?v=2025-01-29-EURO-FIX"></script>
    <script>
        // Carregar itens do catálogo no select
        document.addEventListener('DOMContentLoaded', async function () {
            await carregarItensInline();
            await carregarSelectClientes();

            // Definir data de hoje automaticamente
            const dataInput = document.getElementById('input-validade');
            if (dataInput) {
                const hoje = new Date().toISOString().split('T')[0];
                dataInput.value = hoje;
            }
        });

        // Função para abrir modal de novo cliente
        function novoCliente() {
            const form = document.getElementById('form-cliente');
            if (form) form.reset();
            document.getElementById('cli-id').value = '';
            document.getElementById('modal-cliente-titulo').innerText = 'Novo Cliente';
            const btn = document.querySelector('button[onclick="salvarCliente()"]');
            if (btn) btn.innerHTML = '<i class="ph-bold ph-check"></i> Guardar Cliente';
            toggleModal('modal-cliente', 'open');
        }

        async function carregarItensInline() {
            const select = document.getElementById('select-item-inline');
            if (!select) return;

            try {
                const { data: itens } = await sb.from('itens').select('*').order('nome');
                select.innerHTML = '<option value="">Selecione um item do catálogo...</option>';

                if (itens && itens.length > 0) {
                    itens.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.innerText = `${item.nome} - ${formatarMoeda(item.preco)}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar itens:', error);
            }
        }

        // Carregar clientes no select
        async function carregarSelectClientes() {
            const select = document.getElementById('select-cliente');
            if (!select) return;

            try {
                const { data: clientes } = await sb.from('clientes').select('*').order('nome');
                select.innerHTML = '<option value="">Selecione para preencher...</option>';

                if (clientes && clientes.length > 0) {
                    clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.id;
                        option.innerText = cliente.nome;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Preencher campos quando selecionar cliente
        async function preencherDadosCliente() {
            const select = document.getElementById('select-cliente');
            const clienteId = select.value;

            if (!clienteId) {
                // Limpar campos
                limparCamposCliente();
                return;
            }

            try {
                const { data: cliente, error } = await sb.from('clientes').select('*').eq('id', clienteId).single();
                if (error) throw error;

                if (cliente) {
                    document.getElementById('novo-cli-nome').value = cliente.nome || '';
                    document.getElementById('novo-cli-email').value = cliente.email || '';
                    document.getElementById('novo-cli-phone').value = cliente.phone || '';
                    document.getElementById('novo-cli-cpf').value = cliente.cpf || '';
                    document.getElementById('novo-cli-empresa').value = cliente.empresa || '';
                    document.getElementById('novo-cli-endereco').value = cliente.endereco || '';
                    // Manter a data de hoje, não sobrescrever com valor do cliente
                    // document.getElementById('input-validade').value = cliente.validade_orcamento || '';
                }
            } catch (error) {
                console.error('Erro ao buscar cliente:', error);
            }
        }

        // Salvar cliente automaticamente se for novo
        async function salvarClienteSeNovo() {
            const nome = document.getElementById('novo-cli-nome').value.trim();
            const email = document.getElementById('novo-cli-email').value.trim();
            const telefone = document.getElementById('novo-cli-phone').value.trim();
            const nif = document.getElementById('novo-cli-cpf').value.trim();
            const empresa = document.getElementById('novo-cli-empresa').value.trim();
            const endereco = document.getElementById('novo-cli-endereco').value.trim();
            const validade = document.getElementById('input-validade').value;
            const selectCliente = document.getElementById('select-cliente').value;

            // Se já tem cliente selecionado, não salva
            if (selectCliente) return selectCliente;

            // Se não tem nome, não salva
            if (!nome) return null;

            try {
                const { data: { user } } = await sb.auth.getUser();
                if (!user) throw new Error("Usuário não logado");

                // Verificar se cliente já existe pelo nome (usa maybeSingle para não dar erro)
                const { data: clienteExistente, error: errorBusca } = await sb.from('clientes')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('nome', nome)
                    .maybeSingle();

                // Ignora erro de busca, segue para criar novo
                if (clienteExistente && clienteExistente.id) {
                    // Cliente já existe, usar ele
                    document.getElementById('select-cliente').value = clienteExistente.id;
                    return clienteExistente.id;
                }

                // Salvar novo cliente
                const payload = {
                    user_id: user.id,
                    nome,
                    email,
                    phone: telefone,
                    cpf: nif,
                    empresa,
                    endereco
                };

                const { data, error } = await sb.from('clientes').insert([payload]).select();
                if (error) throw error;

                if (data && data.length > 0) {
                    console.log('Cliente salvo:', data[0]);

                    // Recarregar o select para incluir o novo cliente
                    await carregarSelectClientes();

                    // Selecionar o novo cliente no select
                    document.getElementById('select-cliente').value = data[0].id;

                    return data[0].id;
                }
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                // Não mostra alert para não atrapalhar o fluxo
                return null;
            }

            return null;
        }

        // Expor no escopo global para o app.js acessar
        window.salvarClienteSeNovo = salvarClienteSeNovo;

        // Limpar campos do cliente
        function limparCamposCliente() {
            document.getElementById('novo-cli-nome').value = '';
            document.getElementById('novo-cli-email').value = '';
            document.getElementById('novo-cli-phone').value = '';
            document.getElementById('novo-cli-cpf').value = '';
            document.getElementById('novo-cli-empresa').value = '';
            document.getElementById('novo-cli-endereco').value = '';
            document.getElementById('select-cliente').value = '';
            // Manter a data de hoje, não limpar o campo
            // document.getElementById('input-validade').value = '';

            // Restaurar data de hoje se necessário
            const dataInput = document.getElementById('input-validade');
            if (dataInput && !dataInput.value) {
                const hoje = new Date().toISOString().split('T')[0];
                dataInput.value = hoje;
            }
        }

        // Preencher campos quando selecionar item do catálogo
        function preencherItemInline() {
            const select = document.getElementById('select-item-inline');
            const itemId = select.value;

            if (!itemId) {
                // Limpar campos
                document.getElementById('inline-nome').value = '';
                document.getElementById('inline-preco').value = '';
                document.getElementById('inline-descricao').value = '';
                document.getElementById('inline-tipo').value = 'Serviço';
                toggleInlineTipo();
                return;
            }

            // Buscar item completo do banco
            sb.from('itens').select('*').eq('id', itemId).single()
                .then(({ data, error }) => {
                    if (error) throw error;
                    if (data) {
                        document.getElementById('inline-nome').value = data.nome;
                        document.getElementById('inline-preco').value = data.preco.toFixed(2).replace('.', ',');
                        document.getElementById('inline-descricao').value = data.descricao || '';
                        document.getElementById('inline-tipo').value = data.tipo || 'Serviço';
                        toggleInlineTipo();

                        // Preencher mão de obra ou frete
                        if (data.tipo === 'Serviço') {
                            document.getElementById('inline-mao-obra').value = (data.mao_de_obra || 0).toFixed(2).replace('.', ',');
                        } else {
                            document.getElementById('inline-frete').value = (data.frete || 0).toFixed(2).replace('.', ',');
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar item:', error);
                });
        }

        // Adicionar item (salva no catálogo se for novo)
        async function adicionarItemInline() {
            const nome = document.getElementById('inline-nome').value.trim();
            const descricao = document.getElementById('inline-descricao').value.trim();
            const precoStr = document.getElementById('inline-preco').value.replace('€', '').trim().replace(',', '.');
            const tipo = document.getElementById('inline-tipo').value;
            const selectItem = document.getElementById('select-item-inline').value;

            const preco = parseFloat(precoStr) || 0;

            if (!nome || preco <= 0) {
                alert('Preencha o nome e o preço do item!');
                return;
            }

            let mao_de_obra = 0;
            let frete = 0;

            if (tipo === 'Serviço') {
                const moStr = document.getElementById('inline-mao-obra').value.replace('€', '').trim().replace(',', '.');
                mao_de_obra = parseFloat(moStr) || 0;
            } else {
                const freteStr = document.getElementById('inline-frete').value.replace('€', '').trim().replace(',', '.');
                frete = parseFloat(freteStr) || 0;
            }

            let itemId = selectItem;

            // Se não for um item do catálogo, salvar no banco primeiro
            if (!selectItem) {
                try {
                    const { data: { user } } = await sb.auth.getUser();
                    if (!user) throw new Error("Usuário não logado");

                    const payload = {
                        user_id: user.id,
                        nome,
                        tipo,
                        preco,
                        mao_de_obra,
                        frete,
                        descricao
                    };

                    const { data, error } = await sb.from('itens').insert([payload]).select();
                    if (error) throw error;

                    if (data && data.length > 0) {
                        itemId = data[0].id;
                        console.log('Item salvo no catálogo:', data[0]);

                        // Recarregar o select para incluir o novo item
                        await carregarItensInline();

                        // Selecionar o novo item no select
                        document.getElementById('select-item-inline').value = itemId;
                    }
                } catch (error) {
                    console.error('Erro ao salvar item no catálogo:', error);
                    alert('Erro ao salvar item no catálogo: ' + error.message);
                    return;
                }
            }

            // Adicionar ao orçamento
            const item = {
                id: itemId,
                nome,
                descricao,
                preco,
                tipo,
                qtd: 1,
                mao_de_obra,
                frete
            };

            // Verificar se já existe um array de itens
            if (!window.itensOrcamento) {
                window.itensOrcamento = [];
            }

            window.itensOrcamento.push(item);
            atualizarTabelaItens();

            // Limpar campos
            document.getElementById('inline-nome').value = '';
            document.getElementById('inline-preco').value = '';
            document.getElementById('inline-descricao').value = '';
            document.getElementById('inline-mao-obra').value = '';
            document.getElementById('inline-frete').value = '';
            document.getElementById('select-item-inline').value = '';
            document.getElementById('inline-tipo').value = 'Serviço';
            toggleInlineTipo();
        }

        // Atualizar tabela de itens (função auxiliar)
        function atualizarTabelaItens() {
            const tbody = document.getElementById('lista-itens-orcamento');
            const emptyState = document.getElementById('empty-itens');
            const totalDisplay = document.getElementById('orc-valor');
            const subtotalProdutos = document.getElementById('subtotal-produtos');
            const subtotalMaoObra = document.getElementById('subtotal-mao-obra');
            const subtotalFrete = document.getElementById('subtotal-frete');
            const inputValor = document.getElementById('input-valor');
            const inputItensJson = document.getElementById('input-itens-json');

            if (!tbody || !window.itensOrcamento) return;

            tbody.innerHTML = '';
            let totalProd = 0;
            let totalMO = 0;
            let totalFrete = 0;

            if (window.itensOrcamento.length === 0) {
                if (emptyState) emptyState.style.display = 'flex';
            } else {
                if (emptyState) emptyState.style.display = 'none';

                window.itensOrcamento.forEach((item, index) => {
                    const qtd = item.qtd || 1;
                    const preco = Number(item.preco) || 0;
                    const mo = Number(item.mao_de_obra) || 0;
                    const frete = Number(item.frete) || 0;

                    const subProd = preco * qtd;
                    const subMO = mo * qtd;
                    const subFrete = frete * qtd;
                    const valorTotalItem = subProd + subMO + subFrete;

                    totalProd += subProd;
                    totalMO += subMO;
                    totalFrete += subFrete;

                    tbody.innerHTML += `
                    <tr class="group hover:bg-slate-50 border-b border-slate-50 last:border-0">
                        <td class="p-3 pl-5">
                            <div class="font-bold text-slate-700 text-sm">${item.nome}</div>
                            <div class="text-xs text-slate-500 mt-0.5 leading-relaxed">${item.descricao || ''}</div>
                        </td>
                        <td class="p-3 text-right font-bold text-slate-800 text-sm">
                            ${formatarMoeda(valorTotalItem)}
                        </td>
                        <td class="p-3 text-center">
                            <button type="button" onclick="removerItemOrcamento(${index})" class="text-slate-300 hover:text-red-500 p-1.5 rounded-lg hover:bg-red-50 transition-colors">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                });
            }

            const total = totalProd + totalMO + totalFrete;

            // Atualizar displays
            if (subtotalProdutos) subtotalProdutos.innerText = formatarMoeda(totalProd);
            if (subtotalMaoObra) subtotalMaoObra.innerText = formatarMoeda(totalMO);
            if (subtotalFrete) subtotalFrete.innerText = formatarMoeda(totalFrete);
            if (totalDisplay) totalDisplay.innerText = formatarMoeda(total);

            // Atualizar campos ocultos
            if (inputValor) inputValor.value = total.toFixed(2).replace('.', ',');
            if (inputItensJson) inputItensJson.value = JSON.stringify(window.itensOrcamento);
        }

        // Remover item do orçamento
        function removerItemOrcamento(index) {
            if (window.itensOrcamento) {
                window.itensOrcamento.splice(index, 1);
                atualizarTabelaItens();
            }
        }

        // Alternar entre mão de obra e frete
        function toggleInlineTipo() {
            const tipo = document.getElementById('inline-tipo').value;
            const boxMO = document.getElementById('inline-box-mo');
            const boxFrete = document.getElementById('inline-box-frete');

            if (tipo === 'Serviço') {
                boxMO.classList.remove('hidden');
                boxFrete.classList.add('hidden');
            } else {
                boxMO.classList.add('hidden');
                boxFrete.classList.remove('hidden');
            }
        }
    </script>
</body>

</html>